<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/base}"
  lang="id"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - WatchList</title>
  </head>
  <body>
    <div layout:fragment="content" class="mt-4">
      <div class="card shadow-sm">
        <!-- Header -->
        <div class="card-header bg-white d-flex align-items-center justify-content-between py-3">
          <div>
            <h4 class="mb-0 text-primary fw-bold">Hi, [[${auth.name}]]! ðŸ‘‹</h4>
            <small class="text-muted">Kelola daftar tontonanmu di sini</small>
          </div>
          <div>
            <a th:href="@{/auth/logout}" class="btn btn-sm btn-outline-danger">
              <i class="bi bi-box-arrow-right"></i> Keluar
            </a>
          </div>
        </div>

        <div class="card-body">
          <!-- Tombol Tambah & Search (Optional layout) -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0 fw-bold">Daftar Tontonan</h5>
            <button
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#addWatchListModal"
            >
              <i class="bi bi-plus-lg"></i> Tambah Tontonan
            </button>
          </div>
          
          <!-- Filter Sederhana (Contoh UI statis, perlu implementasi backend search jika ingin berfungsi) -->
          <!-- 
          <form class="row g-2 mb-3" action="/watchlists" method="get">
             <div class="col-auto">
                 <input type="text" name="search" class="form-control form-control-sm" placeholder="Cari judul..." th:value="${param.search}">
             </div>
             <div class="col-auto">
                 <button type="submit" class="btn btn-sm btn-outline-primary">Cari</button>
             </div>
          </form>
          -->

          <!-- Table -->
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th class="text-center" width="5%">No</th>
                  <th width="25%">Judul</th>
                  <th width="10%">Tipe</th>
                  <th width="10%">Genre</th>
                  <th width="10%">Tahun</th>
                  <th width="10%" class="text-center">Rating</th>
                  <th width="10%" class="text-center">Status</th>
                  <th width="20%" class="text-center">Aksi</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="item, status : ${watchLists}">
                  <td class="text-center fw-bold" th:text="${status.index + 1}"></td>
                  <td>
                    <span class="fw-bold text-dark" th:text="${item.title}"></span>
                  </td>
                  <td>
                    <span th:if="${item.type == 'Movie'}" class="badge bg-primary">Movie</span>
                    <span th:if="${item.type == 'Series'}" class="badge bg-info text-dark">Series</span>
                  </td>
                  <td>
                    <span class="badge bg-secondary" th:text="${item.genre}"></span>
                  </td>
                  <td th:text="${item.releaseYear}"></td>
                  <td class="text-center">
                     <span class="fw-bold" th:text="${item.rating}"></span>
                     <i class="bi bi-star-fill text-warning small"></i>
                  </td>
                  <td class="text-center">
                    <span th:if="${item.isWatched}" class="badge rounded-pill bg-success">
                        <i class="bi bi-check"></i> Watched
                    </span>
                    <span th:unless="${item.isWatched}" class="badge rounded-pill bg-light text-dark border">
                        <i class="bi bi-hourglass"></i> Plan
                    </span>
                  </td>
                  <td class="text-center">
                    <!-- Tombol Detail -->
                    <a
                      th:href="@{/watchlists/{id}(id=${item.id})}"
                      class="btn btn-sm btn-info text-white me-1"
                      title="Lihat Detail"
                    >
                      <i class="bi bi-eye"></i>
                    </a>
                    
                    <!-- Tombol Edit -->
                    <button
                      th:id="|editWatchListButton_${item.id}|"
                      th:attr="onclick=|prepareEditWatchList('${item.id}', '${item.title}', '${item.type}', '${item.genre}', ${item.rating}, ${item.releaseYear}, ${item.isWatched}, `${item.notes}`)|"
                      class="btn btn-sm btn-warning me-1"
                      title="Edit Data"
                    >
                      <i class="bi bi-pencil"></i>
                    </button>
                    
                    <!-- Tombol Hapus -->
                    <button
                      th:id="|deleteWatchListButton_${item.id}|"
                      th:attr="onclick=|prepareDeleteWatchList('${item.id}', '${item.title}')|"
                      class="btn btn-sm btn-danger"
                      title="Hapus Data"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr th:if="${#lists.isEmpty(watchLists)}">
                  <td colspan="8" class="text-center py-5 text-muted">
                    <i class="bi bi-film mb-2" style="font-size: 2rem;"></i>
                    <p class="mb-0">Belum ada daftar tontonan. Yuk tambah sekarang!</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Summary Cards -->
          <div class="row mt-4">
            <!-- Total Tontonan -->
            <div class="col-md-4 mb-3">
              <div class="card bg-primary text-white h-100 shadow-sm border-0">
                <div class="card-body d-flex align-items-center justify-content-between">
                  <div>
                    <h6 class="card-title mb-1 opacity-75">Total Tontonan</h6>
                    <h2 class="fw-bold mb-0" th:text="${watchLists != null ? watchLists.size() : 0}">0</h2>
                  </div>
                  <i class="bi bi-collection-play display-4 opacity-50"></i>
                </div>
              </div>
            </div>
            
            <!-- Sudah Ditonton -->
            <div class="col-md-4 mb-3">
              <div class="card bg-success text-white h-100 shadow-sm border-0">
                <div class="card-body d-flex align-items-center justify-content-between">
                  <div>
                    <h6 class="card-title mb-1 opacity-75">Sudah Ditonton</h6>
                    <h2 class="fw-bold mb-0" 
                        th:text="${watchLists != null ? watchLists.stream().filter(w -> w.isWatched).count() : 0}">
                        0
                    </h2>
                  </div>
                  <i class="bi bi-check-circle display-4 opacity-50"></i>
                </div>
              </div>
            </div>
            
            <!-- Rencana Tonton -->
            <div class="col-md-4 mb-3">
              <div class="card bg-secondary text-white h-100 shadow-sm border-0">
                <div class="card-body d-flex align-items-center justify-content-between">
                  <div>
                    <h6 class="card-title mb-1 opacity-75">Rencana Nonton</h6>
                    <h2 class="fw-bold mb-0" 
                        th:text="${watchLists != null ? watchLists.stream().filter(w -> !w.isWatched).count() : 0}">
                        0
                    </h2>
                  </div>
                  <i class="bi bi-bookmark display-4 opacity-50"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modals Inclusion -->
      <div th:replace="~{models/watchlists/add :: addWatchListModal}"></div>
      <div th:replace="~{models/watchlists/edit :: editWatchListModal}"></div>
      <div th:replace="~{models/watchlists/delete :: deleteWatchListModal}"></div>
    </div>

    <!-- Scripts -->
    <script layout:fragment="others-js">
      function prepareEditWatchList(id, title, type, genre, rating, releaseYear, isWatched, notes) {
        /* Set nilai pada form edit */
        document.getElementById("editWatchListId").value = id;
        document.getElementById("editWatchListTitle").value = title;
        document.getElementById("editWatchListType").value = type;
        document.getElementById("editWatchListGenre").value = genre;
        document.getElementById("editWatchListRating").value = rating;
        document.getElementById("editWatchListReleaseYear").value = releaseYear;
        
        // Handle boolean value for select option
        document.getElementById("editWatchListIsWatched").value = isWatched.toString();
        
        // Notes might be 'null' text if passed directly from thymeleaf if empty, handle gracefully
        document.getElementById("editWatchListNotes").value = (notes === 'null') ? '' : notes;

        /* Tampilkan modal */
        var editModal = new bootstrap.Modal(
          document.getElementById("editWatchListModal")
        );
        editModal.show();
      }

      function prepareDeleteWatchList(id, title) {
        /* Set nilai pada form delete */
        document.getElementById("deleteWatchListId").value = id;
        document.getElementById("deleteWatchListTitleDisplay").innerText = title; // Untuk tampilan user
        
        // Reset input konfirmasi
        document.getElementById("deleteWatchListConfirmTitle").value = "";

        /* Tampilkan modal */
        var deleteModal = new bootstrap.Modal(
          document.getElementById("deleteWatchListModal")
        );
        deleteModal.show();
      }

      document.addEventListener("DOMContentLoaded", function () {
        /* Auto-open Modal Add */
        var addWatchListModalOpen = "[[${addWatchListModalOpen}]]" === "true";
        if (addWatchListModalOpen) {
          var addModal = new bootstrap.Modal(
            document.getElementById("addWatchListModal")
          );
          addModal.show();
        }

        /* Auto-open Modal Edit */
        var editWatchListModalOpen = "[[${editWatchListModalOpen}]]" === "true";
        if (editWatchListModalOpen) {
          const editWatchListModalId = "[[${editWatchListModalId}]]";
          const buttonEdit = document.getElementById(
            `editWatchListButton_${editWatchListModalId}`
          );
          if (buttonEdit) {
            buttonEdit.click();
          }
        }

        /* Auto-open Modal Delete */
        var deleteWatchListModalOpen = "[[${deleteWatchListModalOpen}]]" === "true";
        if (deleteWatchListModalOpen) {
          const deleteWatchListModalId = "[[${deleteWatchListModalId}]]";
          const buttonDelete = document.getElementById(
            `deleteWatchListButton_${deleteWatchListModalId}`
          );
          if (buttonDelete) {
            buttonDelete.click();
          }
        }
      });
    </script>
  </body>
</html>